apiVersion: {{ include "infrastructureApiVersion" . }}
kind: OpenStackCluster
metadata:
  labels:
    {{- include "labels.common" $ | nindent 4 }}
  name: {{ include "resource.default.name" $ }}
  namespace: {{ $.Release.Namespace }}
  annotations:
    # Let Cluster API clean this resource up.
    helm.sh/resource-policy: keep
spec:
  {{- if .Values.managementCluster }}
  tags:
  - giant_swarm_cluster_{{ .Values.managementCluster }}_{{ include "resource.default.name" $ }}
  {{- end }}
  {{- if .Values.controlPlane.availabilityZones }}
  controlPlaneAvailabilityZones:
  {{- range .Values.controlPlane.availabilityZones }}
  - {{ . | quote }}
  {{- end }}
  {{- end }}
  identityRef:
    name: {{ .Values.cloudConfig }}
    cloudName: {{ .Values.cloudName | quote }}
  apiServerLoadBalancer:
    enabled: true
    allowedCIDRs:
    {{- range .Values.apiServerLoadBalancer.allowedCidrs }}
    - {{ . | quote }}
    {{- end }}
  managedSecurityGroups:
    allowAllInClusterTraffic: true
  {{- if .Values.nodeCIDR }}
  managedSubnets:
    - cidr: {{ .Values.nodeCIDR | quote }}
  {{- else }}
  network:
    name: {{ .Values.networkName }}
  subnet:
    name: {{ .Values.subnetName }}
  {{- end }}
  {{- if .Values.externalNetworkID }}
  externalNetwork:
    id: {{ .Values.externalNetworkID | quote }}
  {{- end }}
  {{- if .Values.dnsNameservers }}
  dnsNameservers:
  {{- range .Values.dnsNameservers }}
  - {{ . | quote }}
  {{- end }}
  {{- end }}
  bastion:
    enabled: false
    spec:
      flavor: {{ .Values.bastion.flavor | quote }}
      {{- if not .Values.nodeCIDR }}
      ports:
        network:
        - filter:
            name: {{ .Values.networkName }}
          subnets:
          - filter:
              name: {{ .Values.subnetName }}
      {{- end }}
      {{- if .Values.bastion.bootFromVolume }}
      rootVolume:
        sizeGiB: {{ .Values.bastion.diskSize }}
      {{- end }}
      image:
        id: {{ .Values.bastion.image | quote }}
